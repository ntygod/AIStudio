# AI服务商与功能模型配置分离需求文档

## 简介

当前系统的AI配置逻辑存在概念混淆：服务商配置和功能模型配置耦合在一起。正确的逻辑应该是：

1. **服务商配置** - 只用于配置 API Key 和 Base URL，不涉及模型选择
2. **功能模型配置** - 为每个AI使用场景选择已配置好的服务商和具体模型
3. **后端使用** - 根据场景查询用户配置的服务商和模型，再通过服务商找到对应的 API Key 和 Base URL

本需求旨在将这两层配置完全分离，提供更清晰的配置逻辑。

## 术语表

- **服务商配置 (Provider Configuration)**: 仅包含服务商类型、API Key和Base URL的基础连接配置，不涉及模型选择
- **功能模型配置 (Functional Model Configuration)**: 为每个AI场景指定使用哪个已配置的服务商及其具体模型
- **AI场景 (AI Scene)**: 系统中使用AI能力的功能场景，如创意生成、结构化生成、长文写作、分析任务、视频生成、语音生成等
- **业务服务 (Business Service)**: 系统中的具体业务功能服务，如角色生成、章节写作、Wiki提取等
- **场景映射 (Scene Mapping)**: 业务服务到AI场景的映射关系
- **AI服务 (AIService)**: 系统核心AI调用服务
- **服务商 (Provider)**: AI服务提供商，如OpenAI、Gemini、DeepSeek、自定义等

## 需求

### 需求 1

**用户故事:** 作为系统管理员，我希望能够独立配置AI服务商的连接信息，这样我就可以管理不同服务商的API访问凭据而不需要关心具体使用哪个模型。

#### 验收标准

1. WHEN 用户配置服务商时 THEN 系统应只要求输入服务商类型、API Key和Base URL，不显示模型选择
2. WHEN 用户保存服务商配置时 THEN 系统应验证API Key和Base URL的有效性
3. WHEN 服务商配置保存成功时 THEN 系统应将配置存储到数据库中并标记为已配置状态
4. THE 系统应支持预定义的服务商类型（Google Gemini、DeepSeek、OpenAI、自定义）
5. WHEN 用户查看服务商列表时 THEN 系统应显示所有服务商类型及其配置状态（已配置/未配置）

### 需求 2

**用户故事:** 作为系统管理员，我希望能够为不同的AI功能场景配置最适合的服务商和模型，这样我就可以优化不同场景的AI表现和成本。

#### 验收标准

1. WHEN 用户配置功能模型时 THEN 系统应在服务商下拉框中只显示已配置好API Key的服务商
2. WHEN 用户选择服务商后 THEN 系统应显示该服务商支持的模型列表供选择
3. WHEN 用户为场景配置模型时 THEN 系统应保存场景、服务商和模型的三元组映射关系
4. THE 系统应支持为每个场景（创意生成、结构化生成、长文写作、分析任务、视频生成、语音生成）独立配置服务商和模型
5. WHEN 功能模型配置更新时 THEN 系统应立即生效无需重启

### 需求 3

**用户故事:** 作为开发者，我希望后端服务在调用AI时能够自动根据场景查询配置并获取正确的连接信息，这样我就可以确保每个业务场景使用最优的AI配置。

#### 验收标准

1. WHEN 后端服务调用AI时 THEN 系统应根据调用服务的类型自动判断对应的AI场景
2. WHEN 确定场景后 THEN 系统应从功能模型配置表查询该场景对应的服务商和模型
3. WHEN 找到场景配置后 THEN 系统应根据服务商从服务商配置表查询对应的API Key和Base URL
4. WHEN 场景没有配置时 THEN 系统应返回明确的错误信息提示用户配置功能模型
5. WHEN 配置的服务商未配置API Key时 THEN 系统应返回明确的错误信息提示用户配置服务商

### 需求 4

**用户故事:** 作为系统用户，我希望在前端界面中能够清晰地看到服务商配置和功能模型配置的分离，这样我就可以更容易地理解和管理AI配置。

#### 验收标准

1. WHEN 用户访问AI配置页面时 THEN 系统应显示两个独立的配置区域：服务商配置和功能模型配置
2. WHEN 用户在服务商配置区域时 THEN 系统应只显示API Key和Base URL输入框，不显示模型选择
3. WHEN 用户在功能模型配置区域时 THEN 系统应为每个场景显示服务商下拉框和模型下拉框
4. WHEN 渲染功能模型配置的服务商下拉框时 THEN 系统应只包含已配置好API Key的服务商选项
5. WHEN 没有任何服务商配置时 THEN 功能模型配置区域应显示提示引导用户先配置服务商

### 需求 5

**用户故事:** 作为系统维护人员，我希望配置数据结构清晰分离，这样我就可以更容易地进行数据迁移和问题排查。

#### 验收标准

1. THE 系统应将服务商配置和功能模型配置存储在不同的数据表中
2. WHEN 查询配置时 THEN 系统应能够通过关联查询获取完整的配置信息
3. THE 系统应支持独立备份和恢复服务商配置和功能模型配置
4. WHEN 删除服务商时 THEN 系统应检查是否有功能模型配置引用该服务商
5. THE 系统应提供配置一致性检查功能

### 需求 6

**用户故事:** 作为业务服务开发者，我希望系统能够根据具体的业务服务自动判断对应的AI使用场景，这样我就可以让不同的业务服务使用最适合的AI模型。

#### 验收标准

1. WHEN 项目创意、角色名生成、创意对话等服务调用AI时 THEN 系统应自动映射到创意生成(creative)场景
2. WHEN 世界观生成、角色设定、大纲生成、细纲生成等服务调用AI时 THEN 系统应自动映射到结构化生成(structure)场景
3. WHEN 章节内容生成、文本润色、续写扩写等服务调用AI时 THEN 系统应自动映射到长文写作(writing)场景
4. WHEN 章节分析、Wiki提取、逻辑预检、角色演化分析等服务调用AI时 THEN 系统应自动映射到分析任务(analysis)场景
5. THE 系统应在代码中维护业务服务到AI场景的映射关系，便于扩展和维护

#### 业务服务到场景映射参考

| 场景 | 场景代码 | 业务服务示例 | 特点 |
|------|----------|-------------|------|
| 创意生成 | creative | 项目创意、角色名生成、创意对话、GeneralChatHandler | 高创造性、高温度 |
| 结构化生成 | structure | 世界观生成、角色设定、大纲生成、细纲生成、InitializationHandler、PlottingHandler | 结构化输出、中等温度 |
| 长文写作 | writing | 章节内容生成、文本润色、续写扩写、DraftingHandler | 长文本生成、流式输出 |
| 分析任务 | analysis | 章节分析、Wiki提取、逻辑预检、角色演化分析、意图识别、语义扩展、RAG查询增强 | 低温度、高准确性 |
| 视频生成 | video | AI视频工作室（预留） | 多模态生成 |
| 语音生成 | speech | TTS文字转语音（预留） | 语音合成 |

**分析任务场景包含的服务：**
- PreflightService（逻辑预检）
- EvolutionService（角色演化分析）
- IntentRecognitionService（意图识别）
- QueryExpansionService（语义扩展）
- IntentRecognitionEnhancementService（RAG增强意图识别）

**注意：** 
- RAG系统中的Embedding服务使用独立的本地模型或云端Embedding API，不走上述场景配置
- 意图识别、语义扩展等辅助服务需要快速响应和高准确性，建议使用低温度配置

### 需求 7

**用户故事:** 作为系统用户，我希望这个配置分离只影响AI相关功能，这样我就可以确保其他系统功能不受影响。

#### 验收标准

1. THE 系统应只修改AI配置相关的数据结构和接口
2. THE 系统应保持所有非AI功能的现有行为不变
3. WHEN 业务服务调用AI时 THEN 系统应在内部自动处理场景判断和配置选择
4. THE 系统应保持现有AI接口的基本调用方式不变
5. THE 系统应确保配置变更不影响用户管理、项目管理等其他功能模块